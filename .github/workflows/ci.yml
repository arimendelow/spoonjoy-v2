name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    name: ğŸ´ Quality Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.28.1'

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: pnpm prisma:generate

      - name: ğŸ”’ Verify blake3 override resolution
        run: |
          pnpm why blake3-wasm
          pnpm why @c4312/blake3-internal

      - name: ğŸ—„ï¸ Apply D1 migrations (local)
        run: pnpm exec wrangler d1 migrations apply DB --local

      - name: ğŸ—„ï¸ Apply Prisma schema to test database
        run: DATABASE_URL="file:./test.db" pnpm exec prisma db push --skip-generate

      - name: ğŸ” CI preflight - seed backend + migration status
        run: |
          echo "Seed script backend: Cloudflare D1 via wrangler getPlatformProxy()"
          DATABASE_URL=${DATABASE_URL:-'<unset>'}
          echo "DATABASE_URL=$DATABASE_URL"
          echo ""
          echo "Migrations status (wrangler):"
          pnpm exec wrangler d1 migrations list DB --local
          echo ""
          echo "Tables before seed:"
          pnpm exec wrangler d1 execute DB --local --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"

      - name: ğŸŒ± Seed local D1 database
        run: pnpm db:seed

      - name: ğŸ§ª Test & Coverage
        run: pnpm test:coverage

      - name: ğŸ—ï¸ Build
        run: pnpm build

  e2e:
    name: ğŸ­ Playwright E2E Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.28.1'

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: pnpm prisma:generate

      - name: ğŸ”’ Verify blake3 override resolution
        run: |
          pnpm why blake3-wasm
          pnpm why @c4312/blake3-internal

      - name: ğŸ­ Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: ğŸ—„ï¸ Apply D1 migrations
        run: pnpm exec wrangler d1 migrations apply DB --local

      - name: ğŸš¦ Fast web server boot check
        run: |
          set -euo pipefail
          rm -f /tmp/spoonjoy-dev.log
          pnpm dev > /tmp/spoonjoy-dev.log 2>&1 &
          DEV_PID=$!

          cleanup() {
            kill "$DEV_PID" 2>/dev/null || true
            wait "$DEV_PID" 2>/dev/null || true
          }
          trap cleanup EXIT

          for i in {1..30}; do
            if curl -fsS http://localhost:5173 >/dev/null; then
              echo "âœ… dev server responded on attempt $i"
              exit 0
            fi
            sleep 2
          done

          echo "âŒ dev server failed to boot within 60s"
          echo "--- /tmp/spoonjoy-dev.log (tail) ---"
          tail -n 200 /tmp/spoonjoy-dev.log || true
          exit 1

      - name: ğŸ­ Run Playwright tests
        run: pnpm test:e2e

      - name: ğŸ“¤ Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
